name: Build RPM

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build_rpm:
    runs-on: ubuntu-latest
    container: fedora:latest
    permissions:
      contents: write # Needed to upload to release

    steps:
      # Install git and build dependencies. Fedora's minimal image may not have them.
      - name: Install dependencies
        run: |
          dnf install -y git rpm-build rust cargo tar gzip openssl-devel gh

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || github.ref }}

      - name: Prepare Source
        run: |
          # Extract version from Cargo.toml
          VERSION=$(grep '^version =' Cargo.toml | head -n1 | cut -d '"' -f 2)
          echo "Detected version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # Prepare directory for archiving to match %setup -q in the spec file.
          # Use a temp directory to avoid self-referencing.
          mkdir -p /tmp/jico-$VERSION
          cp -r . /tmp/jico-$VERSION/
          rm -rf /tmp/jico-$VERSION/.git
          
          # Create tarball in the current working directory
          tar -czf jico-$VERSION.tar.gz -C /tmp jico-$VERSION
          
          # Setup rpmbuild directory structure
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mv jico-$VERSION.tar.gz ~/rpmbuild/SOURCES/

      - name: Build RPM
        run: |
          # Run rpmbuild, passing the extracted version
          rpmbuild -ba packaging/jico.spec --define "version ${{ env.VERSION }}"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: jico-rpm
          path: ~/rpmbuild/RPMS/**/*.rpm

      - name: Upload RPM to Release
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find the RPM file
          RPM_FILE=$(find ~/rpmbuild/RPMS -name "*.rpm" | head -n 1)
          echo "Found RPM: $RPM_FILE"
          
          # Upload to the release that triggered this workflow
          gh release upload ${{ github.event.release.tag_name }} "$RPM_FILE" --clobber
