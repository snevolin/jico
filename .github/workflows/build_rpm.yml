name: Build RPM

on:
  push:
    tags:
      - '**[0-9]+.[0-9]+.[0-9]+*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to upload RPM to (e.g. v0.0.4). Optional."
        required: false
        type: string

jobs:
  build_rpm:
    runs-on: ubuntu-latest
    container: fedora:latest
    permissions:
      contents: write # Needed to upload to release

    steps:
      - name: Resolve ref/tag context
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          CHECKOUT_REF="${GITHUB_REF}"
          RELEASE_TAG=""
          UPLOAD="false"

          if [[ "${{ github.event_name }}" == "release" ]]; then
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            CHECKOUT_REF="${RELEASE_TAG}"
            UPLOAD="true"
          elif [[ -n "${{ inputs.tag }}" ]]; then
            RELEASE_TAG="${{ inputs.tag }}"
            CHECKOUT_REF="${RELEASE_TAG}"
            UPLOAD="true"
          elif [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            RELEASE_TAG="${GITHUB_REF_NAME}"
            UPLOAD="true"
          fi

          echo "checkout_ref=${CHECKOUT_REF}" >> "$GITHUB_OUTPUT"
          echo "release_tag=${RELEASE_TAG}" >> "$GITHUB_OUTPUT"
          echo "upload_to_release=${UPLOAD}" >> "$GITHUB_OUTPUT"

          echo "checkout_ref=${CHECKOUT_REF}"
          echo "release_tag=${RELEASE_TAG}"
          echo "upload_to_release=${UPLOAD}"

      # Install git and build dependencies. Fedora's minimal image may not have them.
      - name: Install dependencies
        run: |
          dnf install -y git rpm-build rust cargo tar gzip openssl-devel gh jq

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.meta.outputs.checkout_ref }}

      - name: Prepare Source
        run: |
          # Extract version from Cargo.toml
          VERSION=$(grep '^version =' Cargo.toml | head -n1 | cut -d '"' -f 2)
          echo "Detected version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # Prepare directory for archiving to match %setup -q in the spec file.
          # Use a temp directory to avoid self-referencing.
          mkdir -p /tmp/jico-$VERSION
          cp -r . /tmp/jico-$VERSION/
          rm -rf /tmp/jico-$VERSION/.git
          
          # Create tarball in the current working directory
          tar -czf jico-$VERSION.tar.gz -C /tmp jico-$VERSION
          
          # Setup rpmbuild directory structure
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mv jico-$VERSION.tar.gz ~/rpmbuild/SOURCES/

      - name: Build RPM
        run: |
          # Run rpmbuild, passing the extracted version
          rpmbuild -ba packaging/jico.spec --define "version ${{ env.VERSION }}"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: jico-rpm
          path: ~/rpmbuild/RPMS/**/*.rpm

      - name: Upload RPM to Release
        id: upload_rpm
        if: steps.meta.outputs.upload_to_release == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.meta.outputs.release_tag }}"

          # Upload the main package, not debug subpackages.
          RPM_FILE=$(find ~/rpmbuild/RPMS -name "jico-*.rpm" | grep -Ev '(debuginfo|debugsource)' | head -n 1 || true)
          if [[ -z "$RPM_FILE" ]]; then
            echo "Main jico RPM not found under ~/rpmbuild/RPMS."
            find ~/rpmbuild/RPMS -name "*.rpm" -print
            exit 1
          fi
          RPM_NAME="$(basename "$RPM_FILE")"
          echo "Found main RPM: $RPM_FILE"
          echo "rpm_asset_name=$RPM_NAME" >> "$GITHUB_OUTPUT"

          # Release creation can race with tag-push builds.
          # Retry upload until the release appears.
          UPLOADED="false"
          for i in $(seq 1 30); do
            if gh release upload "$TAG" "$RPM_FILE" -R "$GITHUB_REPOSITORY" --clobber; then
              UPLOADED="true"
              break
            fi
            echo "Release $TAG not ready yet (attempt $i/30), waiting..."
            sleep 10
          done

          if [[ "$UPLOADED" != "true" ]]; then
            echo "Failed to upload RPM to release $TAG after retries."
            exit 1
          fi

      - name: Update release notes with RPM link
        if: steps.meta.outputs.upload_to_release == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.meta.outputs.release_tag }}"
          RPM_NAME="${{ steps.upload_rpm.outputs.rpm_asset_name }}"

          RELEASE_JSON="$(gh api "repos/$GITHUB_REPOSITORY/releases/tags/$TAG")"
          RELEASE_ID="$(jq -r '.id' <<<"$RELEASE_JSON")"
          RELEASE_BODY="$(jq -r '.body // \"\"' <<<"$RELEASE_JSON")"
          RPM_URL="$(jq -r --arg name "$RPM_NAME" '.assets[] | select(.name == $name) | .browser_download_url' <<<"$RELEASE_JSON" | head -n 1)"

          if [[ -z "$RPM_URL" || "$RPM_URL" == "null" ]]; then
            echo "Could not resolve browser_download_url for asset $RPM_NAME in release $TAG"
            exit 1
          fi

          START_MARKER="<!-- jico-rpm-start -->"
          END_MARKER="<!-- jico-rpm-end -->"
          RPM_SECTION="$(cat <<EOF
$START_MARKER
### RPM package
- [$RPM_NAME]($RPM_URL)
$END_MARKER
EOF
)"

          CLEAN_BODY="$(printf '%s\n' "$RELEASE_BODY" | awk -v start="$START_MARKER" -v end="$END_MARKER" '
            BEGIN { skip = 0 }
            index($0, start) { skip = 1; next }
            index($0, end) { skip = 0; next }
            !skip { print }
          ')"

          while [[ "$CLEAN_BODY" == *$'\n' ]]; do
            CLEAN_BODY="${CLEAN_BODY%$'\n'}"
          done

          if [[ -n "$CLEAN_BODY" ]]; then
            UPDATED_BODY="$CLEAN_BODY"$'\n\n'"$RPM_SECTION"
          else
            UPDATED_BODY="$RPM_SECTION"
          fi

          gh api -X PATCH "repos/$GITHUB_REPOSITORY/releases/$RELEASE_ID" -f body="$UPDATED_BODY" >/dev/null
          echo "Release notes for $TAG updated with RPM link."
